<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ELRON – GitHub Issues</title>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px 0; }
    .bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 12px 0 18px; }
    .bar input, .bar select, .bar button, .bar label {
      font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid #8886; background: transparent;
    }
    .bar label { border: none; padding: 0; display:flex; gap:8px; align-items:center; }
    .hint { opacity: .8; font-size: 0.95rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 10px; border-bottom: 1px solid #8884; vertical-align: top; }
    th { position: sticky; top: 0; backdrop-filter: blur(6px); background: color-mix(in oklab, Canvas 88%, transparent); cursor: pointer; user-select: none; }
    th .sort { opacity: .7; font-size: .9em; margin-left: 6px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #8886; margin: 0 6px 6px 0; font-size: .9em; }
    a { color: inherit; }
    .muted { opacity: .75; }
    .error { padding: 12px; border: 1px solid #c33a; border-radius: 12px; }
    .right { margin-left:auto; }
  </style>
</head>

<body>
  <h1>ELRON – GitHub Issues</h1>

  <div class="bar">
    <input id="q" type="search" placeholder="Suchen (Titel, #Nr, Label, Autor…)" style="min-width: 280px;">
    <select id="state">
      <option value="all">Alle (offen + geschlossen)</option>
      <option value="open">Nur offen</option>
      <option value="closed">Nur geschlossen</option>
    </select>
    <select id="labels">
      <option value="">Alle Labels</option>
    </select>
    <label class="hint">
      <input id="includePRs" type="checkbox" />
      PRs einblenden
    </label>
    <button id="reload">Neu laden</button>
    <span class="hint right" id="status"></span>
  </div>

  <div id="msg"></div>

  <table id="tbl" aria-label="Issues Tabelle">
    <thead>
      <tr>
        <th data-key="number"># <span class="sort" id="sort-number"></span></th>
        <th data-key="title">Titel <span class="sort" id="sort-title"></span></th>
        <th data-key="state">Status <span class="sort" id="sort-state"></span></th>
        <th data-key="labelsText">Labels <span class="sort" id="sort-labelsText"></span></th>
        <th data-key="userLogin">Autor <span class="sort" id="sort-userLogin"></span></th>
        <th data-key="created_at">Erstellt <span class="sort" id="sort-created_at"></span></th>
        <th data-key="updated_at">Aktualisiert <span class="sort" id="sort-updated_at"></span></th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
/**
 * === KONFIG ===
 */
const OWNER = "edgar-jung-test";
const REPO  = "ELRON";

/**
 * === HELPERS ===
 */
const $ = (id) => document.getElementById(id);

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function uniq(arr) { return [...new Set(arr)]; }

function isoDate(d) {
  if (!d) return "";
  const dt = new Date(d);
  if (Number.isNaN(dt.getTime())) return String(d);
  return dt.toISOString().slice(0, 10);
}

function parseLinkHeader(link) {
  const out = {};
  if (!link) return out;
  for (const part of link.split(",")) {
    const m = part.match(/<([^>]+)>\s*;\s*rel="([^"]+)"/);
    if (m) out[m[2]] = m[1];
  }
  return out;
}

/**
 * === FETCH ISSUES ===
 */
async function fetchIssuesAllPages({ state="all", perPage=100, includePRs=false } = {}) {
  let url = `https://api.github.com/repos/${OWNER}/${REPO}/issues?state=${encodeURIComponent(state)}&per_page=${perPage}&page=1`;
  const all = [];

  while (url) {
    const res = await fetch(url, {
      headers: { "Accept": "application/vnd.github+json" }
    });

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} beim Laden der Issues.\n${text.slice(0, 300)}`);
    }

    const data = await res.json();

    // Achtung: /issues liefert auch PRs; PRs haben das Feld "pull_request"
    for (const item of data) {
      const isPR = !!item.pull_request;
      if (!includePRs && isPR) continue;
      all.push(item);
    }

    const links = parseLinkHeader(res.headers.get("Link"));
    url = links.next || "";
  }

  return all;
}

/**
 * === STATE / VIEW ===
 */
let ALL = [];
let VIEW = [];
let sortKey = "updated_at";
let sortDir = "desc";

function buildLabelOptions() {
  const labels = uniq(ALL.flatMap(it => (it.labels || []).map(l => l.name)))
    .sort((a,b)=>a.localeCompare(b));
  $("labels").innerHTML =
    `<option value="">Alle Labels</option>` +
    labels.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
}

function applyFilters() {
  const q = $("q").value.trim().toLowerCase();
  const label = $("labels").value;

  VIEW = ALL.filter(it => {
    const labelsText = (it.labels || []).map(l => l.name).join(" ");
    const hay = [
      `#${it.number}`,
      it.title,
      it.state,
      labelsText,
      it.userLogin
    ].join(" ").toLowerCase();

    const okQ = !q || hay.includes(q);
    const okL = !label || (it.labels || []).some(l => l.name === label);
    return okQ && okL;
  });

  applySort();
  render();
  $("status").textContent = `${VIEW.length} / ${ALL.length}`;
}

function compare(a, b) {
  const vaRaw = a?.[sortKey];
  const vbRaw = b?.[sortKey];

  if (sortKey === "number") {
    const va = Number(vaRaw || 0), vb = Number(vbRaw || 0);
    return sortDir === "asc" ? (va - vb) : (vb - va);
  }

  const va = (vaRaw ?? "").toString().toLowerCase();
  const vb = (vbRaw ?? "").toString().toLowerCase();

  if (va < vb) return sortDir === "asc" ? -1 : 1;
  if (va > vb) return sortDir === "asc" ? 1 : -1;
  return 0;
}

function applySort() {
  VIEW.sort(compare);
  document.querySelectorAll("th .sort").forEach(el => el.textContent = "");
  const el = document.getElementById(`sort-${sortKey}`);
  if (el) el.textContent = sortDir === "asc" ? "▲" : "▼";
}

function render() {
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";

  for (const it of VIEW) {
    const tr = document.createElement("tr");
    const labelsHtml = (it.labels || []).map(l => `<span class="pill">${escapeHtml(l.name)}</span>`).join("");
    const isPR = !!it.pull_request;

    tr.innerHTML = `
      <td class="muted">#${escapeHtml(it.number)}</td>
      <td>
        ${escapeHtml(it.title)}
        ${isPR ? `<span class="pill muted" title="Pull Request">PR</span>` : ``}
      </td>
      <td class="muted">${escapeHtml(it.state)}</td>
      <td>${labelsHtml || "<span class='muted'>—</span>"}</td>
      <td class="muted">${escapeHtml(it.userLogin || "—")}</td>
      <td class="muted">${escapeHtml(isoDate(it.created_at) || "—")}</td>
      <td class="muted">${escapeHtml(isoDate(it.updated_at) || "—")}</td>
      <td><a href="${escapeHtml(it.html_url)}" target="_blank" rel="noopener">Link</a></td>
    `;
    tbody.appendChild(tr);
  }
}

/**
 * === INIT ===
 */
async function init() {
  $("msg").innerHTML = "";
  $("status").textContent = "Lade…";

  const state = $("state").value;              // open|closed|all
  const includePRs = $("includePRs").checked;  // optional

  try {
    const issues = await fetchIssuesAllPages({ state, includePRs, perPage: 100 });

    // normalize
    ALL = issues.map(it => ({
      ...it,
      labelsText: (it.labels || []).map(l => l.name).join(", "),
      userLogin: it.user?.login || ""
    }));

    buildLabelOptions();

    sortKey = "updated_at";
    sortDir = "desc";

    applyFilters();
  } catch (err) {
    $("msg").innerHTML = `
      <div class="error">
        <strong>Fehler:</strong><br>
        <pre style="white-space:pre-wrap;margin:8px 0 0;">${escapeHtml(err.message || String(err))}</pre>
      </div>`;
    $("status").textContent = "Fehler";
  }
}

$("q").addEventListener("input", applyFilters);
$("labels").addEventListener("change", applyFilters);
$("state").addEventListener("change", init);
$("includePRs").addEventListener("change", init);
$("reload").addEventListener("click", init);

document.querySelectorAll("th[data-key]").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.getAttribute("data-key");
    if (!key) return;
    if (sortKey === key) sortDir = (sortDir === "asc") ? "desc" : "asc";
    else { sortKey = key; sortDir = "asc"; }
    applySort();
    render();
  });
});

init();
</script>
</body>
</html>


