<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ELRON – Issue Dashboard</title>

  <!-- YAML Parser -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px 0; }
    .bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 12px 0 18px; }
    .bar input, .bar select, .bar button {
      font: inherit; padding: 8px 10px; border-radius: 10px; border: 1px solid #8886; background: transparent;
    }
    .hint { opacity: .8; font-size: 0.95rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 10px; border-bottom: 1px solid #8884; vertical-align: top; }
    th { position: sticky; top: 0; backdrop-filter: blur(6px); background: color-mix(in oklab, Canvas 88%, transparent); cursor: pointer; user-select: none; }
    th .sort { opacity: .7; font-size: .9em; margin-left: 6px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #8886; margin: 0 6px 6px 0; font-size: .9em; }
    a { color: inherit; }
    .muted { opacity: .75; }
    .error { padding: 12px; border: 1px solid #c33a; border-radius: 12px; }
    .right { margin-left:auto; }
    code { font-size: 0.95em; }
  </style>
</head>

<body>
  <h1>ELRON – Issues</h1>

  <div class="bar">
    <input id="q" type="search" placeholder="Suchen (Titel, YAML, Dateiname, Label…)" style="min-width: 260px;">
    <select id="labels">
      <option value="">Alle Labels</option>
    </select>
    <button id="reload">Neu laden</button>
    <span class="hint right" id="status"></span>
  </div>

  <div id="msg"></div>

  <table id="tbl" aria-label="Issue Tabelle">
    <thead>
      <tr>
        <th data-key="title">Titel <span class="sort" id="sort-title"></span></th>
        <th data-key="yamlName">YAML (Klarname) <span class="sort" id="sort-yamlName"></span></th>
        <th data-key="yamlFile">YAML-Datei <span class="sort" id="sort-yamlFile"></span></th>
        <th data-key="labelsText">Labels <span class="sort" id="sort-labelsText"></span></th>
        <th data-key="created">Erstellt <span class="sort" id="sort-created"></span></th>
        <th data-key="updated">Aktualisiert <span class="sort" id="sort-updated"></span></th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
/**
 * === KONFIG ===
 */
const OWNER = "edgar-jung-test";
const REPO  = "ELRON";
const BRANCH = "main";       // ggf. "master"
const YAML_DIR = "issues";   // Ordner mit den .yaml Dateien

/**
 * === HELPERS ===
 */
const $ = (id) => document.getElementById(id);

function yamlKlarname(pathOrFilename) {
  const base = (pathOrFilename || "").split("/").pop() || "";
  const noExt = base.replace(/\.(ya?ml)$/i, "");
  return noExt.replace(/[_-]+/g, " ").trim();
}

function titleCase(s) {
  return (s || "").replace(/\w\S*/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase());
}

function safeDate(d) {
  if (!d) return "";
  const dt = new Date(d);
  if (Number.isNaN(dt.getTime())) return String(d);
  return dt.toISOString().slice(0, 10);
}

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function uniq(arr) {
  return [...new Set(arr)];
}

/**
 * === GITHUB FETCH ===
 */
async function fetchJson(url) {
  const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status} für ${url}\n${text.slice(0, 200)}`);
  }
  return res.json();
}

async function listYamlFiles() {
  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(YAML_DIR)}?ref=${encodeURIComponent(BRANCH)}`;
  const data = await fetchJson(url);

  const files = (Array.isArray(data) ? data : [])
    .filter(x => x && x.type === "file" && /\.(ya?ml)$/i.test(x.name))
    .map(x => ({
      name: x.name,
      path: x.path,
      download_url: x.download_url,
      html_url: x.html_url
    }));

  return files;
}

async function loadYamlFile(file) {
  const res = await fetch(file.download_url);
  if (!res.ok) throw new Error(`Konnte ${file.name} nicht laden (HTTP ${res.status})`);
  const text = await res.text();
  const parsed = jsyaml.load(text) || {};

  const labels = Array.isArray(parsed.labels) ? parsed.labels : (parsed.labels ? [parsed.labels] : []);
  const link = parsed.link || parsed.url || parsed.html_url || file.html_url;

  const yamlName = titleCase(yamlKlarname(file.name));

  return {
    title: parsed.title || parsed.name || yamlName,
    yamlName,
    yamlFile: file.name,          // <- exakter Dateiname
    labels,
    labelsText: labels.join(", "),
    created: safeDate(parsed.created || parsed.created_at),
    updated: safeDate(parsed.updated || parsed.updated_at),
    link,

    _file: file,
    _raw: parsed
  };
}

/**
 * === RENDERING, FILTER, SORT ===
 */
let ALL = [];
let VIEW = [];
let sortKey = "updated";
let sortDir = "desc";

function applyFilters() {
  const q = $("q").value.trim().toLowerCase();
  const label = $("labels").value;

  VIEW = ALL.filter(item => {
    const hay = [
      item.title,
      item.yamlName,
      item.yamlFile,
      item.labelsText,
      item._file?.name,
      item._file?.path
    ].join(" ").toLowerCase();

    const okQ = !q || hay.includes(q);
    const okL = !label || item.labels.includes(label);
    return okQ && okL;
  });

  applySort();
  renderTable();
  $("status").textContent = `${VIEW.length} / ${ALL.length}`;
}

function cmp(a, b) {
  const va = (a?.[sortKey] ?? "").toString().toLowerCase();
  const vb = (b?.[sortKey] ?? "").toString().toLowerCase();

  if (va < vb) return sortDir === "asc" ? -1 : 1;
  if (va > vb) return sortDir === "asc" ? 1 : -1;
  return 0;
}

function applySort() {
  VIEW.sort(cmp);
  document.querySelectorAll("th .sort").forEach(el => el.textContent = "");
  const el = document.getElementById(`sort-${sortKey}`);
  if (el) el.textContent = sortDir === "asc" ? "▲" : "▼";
}

function renderTable() {
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";

  for (const item of VIEW) {
    const tr = document.createElement("tr");
    const labelsHtml = item.labels.map(l => `<span class="pill">${escapeHtml(l)}</span>`).join("");

    tr.innerHTML = `
      <td>${escapeHtml(item.title)}</td>
      <td class="muted">${escapeHtml(item.yamlName)}</td>
      <td class="muted"><code>${escapeHtml(item.yamlFile || "")}</code></td>
      <td>${labelsHtml || "<span class='muted'>—</span>"}</td>
      <td class="muted">${escapeHtml(item.created || "—")}</td>
      <td class="muted">${escapeHtml(item.updated || "—")}</td>
      <td><a href="${escapeHtml(item.link)}" target="_blank" rel="noopener">Link</a></td>
    `;

    tbody.appendChild(tr);
  }
}

function renderLabelFilterOptions() {
  const labels = uniq(ALL.flatMap(x => x.labels)).sort((a,b)=>a.localeCompare(b));
  const sel = $("labels");
  sel.innerHTML = `<option value="">Alle Labels</option>` + labels.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
}

/**
 * === INIT ===
 */
async function init() {
  $("msg").innerHTML = "";
  $("status").textContent = "Lade…";

  try {
    const files = await listYamlFiles();
    if (!files.length) {
      $("msg").innerHTML = `<div class="error">Keine YAML-Dateien gefunden in <code>${escapeHtml(YAML_DIR)}</code> (Branch: <code>${escapeHtml(BRANCH)}</code>).</div>`;
      $("status").textContent = "0 / 0";
      return;
    }

    const out = [];
    const chunkSize = 8;
    for (let i=0;i<files.length;i+=chunkSize) {
      const part = await Promise.all(files.slice(i, i+chunkSize).map(loadYamlFile));
      out.push(...part);
    }

    ALL = out;
    renderLabelFilterOptions();

    sortKey = "updated";
    sortDir = "desc";

    applyFilters();
    $("status").textContent = `${VIEW.length} / ${ALL.length}`;
  } catch (err) {
    $("msg").innerHTML = `<div class="error"><strong>Fehler:</strong><br><pre style="white-space:pre-wrap;margin:8px 0 0;">${escapeHtml(err.message || String(err))}</pre></div>`;
    $("status").textContent = "Fehler";
  }
}

$("q").addEventListener("input", applyFilters);
$("labels").addEventListener("change", applyFilters);
$("reload").addEventListener("click", init);

document.querySelectorAll("th[data-key]").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.getAttribute("data-key");
    if (!key) return;
    if (sortKey === key) sortDir = (sortDir === "asc") ? "desc" : "asc";
    else { sortKey = key; sortDir = "asc"; }
    applySort();
    renderTable();
  });
});

init();
</script>
</body>
</html>
